version: '3.8'

services:
  # Immich - Photo Management (COMMENTED OUT - saves ~512MB RAM)
  # Uncomment if you need photo management. Consider running on Node 1 or NAS instead.
  # immich:
  #   image: ghcr.io/imagegenius/immich:latest
  #   container_name: immich
  #   restart: unless-stopped
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=America/New_York
  #   volumes:
  #     - ./immich:/config
  #     - /mnt/nas/photos:/photos
  #   ports:
  #     - "2283:2283"
  #   networks:
  #     - homelab

  # Nextcloud - File Sync (COMMENTED OUT - saves ~768MB RAM)
  # Uncomment if you need file sync. Consider running on Node 1 or NAS instead.
  # nextcloud:
  #   image: nextcloud:latest
  #   container_name: nextcloud
  #   restart: unless-stopped
  #   environment:
  #     - MYSQL_HOST=mariadb
  #     - MYSQL_DATABASE=nextcloud
  #     - MYSQL_USER=nextcloud
  #     - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
  #     - NEXTCLOUD_TRUSTED_DOMAINS=192.168.1.12
  #   volumes:
  #     - ./nextcloud:/var/www/html
  #     - /mnt/nas/nextcloud:/data
  #   ports:
  #     - "8080:80"
  #   networks:
  #     - homelab
  #   depends_on:
  #     - nextcloud-db

  # nextcloud-db:
  #   image: mariadb:10.11
  #   container_name: nextcloud-db
  #   restart: unless-stopped
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_DB_ROOT_PASSWORD}
  #     - MYSQL_DATABASE=nextcloud
  #     - MYSQL_USER=nextcloud
  #     - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
  #   volumes:
  #     - ./nextcloud-db:/var/lib/mysql
  #   networks:
  #     - homelab

  # Grafana - Monitoring Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}  # Set in .env file
    volumes:
      - ./grafana:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - homelab
    depends_on:
      - influxdb

  # InfluxDB - Time Series Database
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}  # Set in .env file
      - DOCKER_INFLUXDB_INIT_ORG=homelab
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
    volumes:
      - ./influxdb:/var/lib/influxdb2
    ports:
      - "8086:8086"
    networks:
      - homelab

  # Telegraf - Metrics Collector
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}  # Generate after InfluxDB setup
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - homelab
    depends_on:
      - influxdb

  # Stirling PDF - PDF Editor
  stirling-pdf:
    image: stirlingtools/stirling-pdf:latest
    container_name: stirling-pdf
    restart: unless-stopped
    ports:
      - "8083:8080"
    volumes:
      - ./stirling-pdf:/configs
    networks:
      - homelab

  # Docmost - Documentation
  docmost:
    image: docmost/docmost:latest
    container_name: docmost
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://docmost:${DOCMOST_PASSWORD}@docmost-db:5432/docmost
      - SECRET_KEY=${DOCMOST_SECRET_KEY}  # Generate a random key
    volumes:
      - ./docmost:/app/data
    ports:
      - "3002:3000"
    networks:
      - homelab
    depends_on:
      - docmost-db

  docmost-db:
    image: postgres:15-alpine
    container_name: docmost-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=docmost
      - POSTGRES_PASSWORD=${DOCMOST_PASSWORD}  # Set in .env file
      - POSTGRES_DB=docmost
    volumes:
      - ./docmost-db:/var/lib/postgresql/data
    networks:
      - homelab

  # Linkwarden - Bookmarks
  linkwarden:
    image: linkwarden/linkwarden:latest
    container_name: linkwarden
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://linkwarden:${LINKWARDEN_PASSWORD}@linkwarden-db:5432/linkwarden
      - NEXTAUTH_SECRET=${LINKWARDEN_SECRET}  # Generate a random key
      - NEXTAUTH_URL=http://192.168.1.12:3003
    volumes:
      - ./linkwarden:/data
    ports:
      - "3003:3000"
    networks:
      - homelab
    depends_on:
      - linkwarden-db

  linkwarden-db:
    image: postgres:15-alpine
    container_name: linkwarden-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=linkwarden
      - POSTGRES_PASSWORD=${LINKWARDEN_PASSWORD}  # Set in .env file
      - POSTGRES_DB=linkwarden
    volumes:
      - ./linkwarden-db:/var/lib/postgresql/data
    networks:
      - homelab

  # OctoPrint - 3D Printer Management
  octoprint:
    image: octoprint/octoprint:latest
    container_name: octoprint
    restart: unless-stopped
    environment:
      - ENABLE_MJPG_STREAMER=true
    volumes:
      - ./octoprint:/octoprint
    ports:
      - "5000:5000"  # Web UI
      - "8080:8080"  # Webcam stream (if enabled)
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0  # Adjust to your printer's USB device
      - /dev/ttyACM0:/dev/ttyACM0  # Alternative USB device path
      - /dev/video0:/dev/video0    # Webcam device (if using USB webcam)
    privileged: true  # Required for USB device access
    networks:
      - homelab

networks:
  homelab:
    driver: bridge

